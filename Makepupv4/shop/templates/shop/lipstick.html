{% extends "shop/base.html" %}
{% block title %}Try On Lipstick{% endblock %}
{% load static %}

{% block content %}
<style>
    .video-container {
        position: relative;
        display: inline-block;
        margin-top: 30px;
    }

    #video, #canvas {
        width: 500px;
        height: 375px;
        border-radius: 10px;
    }

    #canvas {
        position: absolute;
        top: 0;
        left: 0;
        z-index: 10;
        pointer-events: none;
    }

    .controls {
        margin-top: 20px;
        text-align: center;
    }

    .color-option {
        display: inline-block;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin: 5px;
        cursor: pointer;
        border: 2px solid #fff;
        box-shadow: 0 0 3px rgba(0,0,0,0.4);
        transition: transform 0.2s ease;
    }

    .color-option:hover {
        transform: scale(1.15);
    }

    .price-tag {
        margin-top: 25px;
        font-size: 1.5rem;
        font-weight: bold;
        color: #e63946;
        font-family: 'Poppins', sans-serif;
    }

    .price-tag .old-price {
        text-decoration: line-through;
        color: #888;
        font-size: 1.2rem;
        margin-right: 10px;
    }

    .price-tag span {
        font-size: 1rem;
        font-weight: normal;
        color: #555;
        margin-left: 5px;
    }

    .discount-note {
        margin-top: 8px;
        font-size: 1rem;
        color: #2a9d8f;
        font-weight: 500;
        font-family: 'Poppins', sans-serif;
    }

    .btn-add {
        margin-top: 15px;
        padding: 12px 24px;
        background-color: #111;
        color: #fff;
        border: none;
        border-radius: 6px;
        font-size: 1rem;
        cursor: pointer;
        transition: background 0.2s ease;
    }

    .btn-add:hover {
        background-color: #333;
    }

    h1 {
        text-align: center;
        margin: 40px 0 10px;
        font-size: 2.5rem;
        font-family: 'Poppins', sans-serif;
    }
</style>

<h1>Virtual Lipstick Try-On</h1>

<div class="text-center">
    <div class="video-container">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="canvas"></canvas>
    </div>

    <div class="controls">
        <p class="mt-4">Select Lipstick Color:</p>
        <div id="colorPalette">
            <div class="color-option" style="background:#e35d6a;" data-color="#e35d6a"></div>
            <div class="color-option" style="background:#c98276;" data-color="#c98276"></div>
            <div class="color-option" style="background:#593b2b;" data-color="#593b2b"></div>
            <div class="color-option" style="background:#794856;" data-color="#794856"></div>
            <div class="color-option" style="background:#99586a;" data-color="#99586a"></div>
            <div class="color-option" style="background:#b78693;" data-color="#b78693"></div>
            <div class="color-option" style="background:#ce0018;" data-color="#ce0018"></div>
            <div class="color-option" style="background:#f12840;" data-color="#f12840"></div>
        </div>

        <!-- üí≤ Price Section -->
        <div class="price-tag">
            <span class="old-price">‚Çπ699.00</span>
            ‚Çπ549.00 <span>per lipstick</span>
        </div>
        <div class="discount-note">
            You save ‚Çπ150 (21%)
        </div>

        <!-- ‚úÖ Add to Cart Form -->
        <form method="post" action="{% url 'add_to_cart' 'Lipstick' %}" class="mt-3">
            {% csrf_token %}
            <input type="hidden" name="shade" id="selectedShade" value="#e35d6a">
            <button type="submit" class="btn-add">Add Selected Shade to Cart üõí</button>
        </form>
    </div>
</div>

<div class="text-center mt-4">
    <button onclick="history.back()" style="
        padding: 10px 20px;
        font-size: 1rem;
        border-radius: 6px;
        border: none;
        background-color: black;
        color: white;
        cursor: pointer;
        margin-top: 30px;
    ">
        ‚Üê Go Back
    </button>
</div>

<!-- MediaPipe & Camera -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.min.js"></script>
<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    let selectedColor = "#e35d6a"; // default
    const hiddenShadeInput = document.getElementById('selectedShade');

    // handle color swatch clicks
    document.querySelectorAll('.color-option').forEach(option => {
        option.addEventListener('click', () => {
            selectedColor = option.dataset.color;
            hiddenShadeInput.value = selectedColor; // ‚úÖ update hidden input
        });
    });

    const LIPS = [
        61, 185, 40, 39, 37, 0, 267, 269, 270, 409, 291,
        375, 321, 405, 314, 17, 84, 181, 91, 146,
        78, 95, 88, 178, 87, 14, 317, 402, 318, 324,
        308, 415, 310, 311, 312, 13, 82, 81, 80, 191
    ];

    const faceMesh = new FaceMesh({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
    });

    faceMesh.setOptions({
        maxNumFaces: 1,
        refineLandmarks: true,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });

    faceMesh.onResults(results => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (results.multiFaceLandmarks) {
            for (const landmarks of results.multiFaceLandmarks) {
                const points = LIPS.map(i => [
                    landmarks[i].x * canvas.width,
                    landmarks[i].y * canvas.height
                ]);

                const r = parseInt(selectedColor.substr(1, 2), 16);
                const g = parseInt(selectedColor.substr(3, 2), 16);
                const b = parseInt(selectedColor.substr(5, 2), 16);
                ctx.fillStyle = `rgba(${r}, ${g}, ${b}, 0.6)`;

                ctx.beginPath();
                ctx.moveTo(points[0][0], points[0][1]);
                for (let i = 1; i < points.length; i++) {
                    ctx.lineTo(points[i][0], points[i][1]);
                }
                ctx.closePath();
                ctx.fill();
            }
        }
    });

    const camera = new Camera(video, {
        onFrame: async () => {
            await faceMesh.send({ image: video });
        },
        width: 500,
        height: 375
    });

    camera.start();
</script>
{% endblock %}
