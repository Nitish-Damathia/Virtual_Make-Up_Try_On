{% extends "shop/base.html" %}
{% block title %}Try On Eyeliner{% endblock %}
{% load static %}

{% block content %}
<style>
    .video-container {
        position: relative;
        display: inline-block;
        margin-top: 30px;
    }

    #video, #canvas {
        width: 500px;
        height: 375px;
        border-radius: 10px;
    }

    #canvas {
        position: absolute;
        top: 0;
        left: 0;
        z-index: 10;
        pointer-events: none;
    }

    h1 {
        text-align: center;
        margin: 40px 0 10px;
        font-size: 2.5rem;
        font-family: 'Poppins', sans-serif;
    }

    .controls {
        margin-top: 20px;
        text-align: center;
    }

    input[type="color"] {
        width: 100px;
        height: 40px;
        border: none;
        cursor: pointer;
    }

    .price-tag {
        margin-top: 25px;
        font-size: 1.5rem;
        font-weight: bold;
        color: #e63946;
        font-family: 'Poppins', sans-serif;
    }

    .price-tag .old-price {
        text-decoration: line-through;
        color: #888;
        font-size: 1.2rem;
        margin-right: 10px;
    }

    .price-tag span {
        font-size: 1rem;
        font-weight: normal;
        color: #555;
        margin-left: 5px;
    }

    .discount-note {
        margin-top: 8px;
        font-size: 1rem;
        color: #2a9d8f;
        font-weight: 500;
        font-family: 'Poppins', sans-serif;
    }

    .btn-add {
        margin-top: 25px;
        padding: 12px 24px;
        background-color: #111;
        color: #fff;
        border: none;
        border-radius: 6px;
        font-size: 1rem;
        cursor: pointer;
        transition: background 0.2s ease;
    }
    .btn-add:hover {
        background-color: #333;
    }
</style>

<h1>Virtual Eyeliner Try-On</h1>

<div class="text-center">
    <div class="video-container">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="canvas"></canvas>
    </div>

    <div class="controls">
        <label for="eyelinerColor" class="mt-4">Select Eyeliner Color:</label><br>
        <input type="color" id="eyelinerColor" value="#000000">
    </div>

     <!-- üí≤ Price Section -->
        <div class="price-tag">
            <span class="old-price">‚Çπ699.00</span>
            ‚Çπ449.00 <span>per Piece</span>
        </div>
        <div class="discount-note">
            You save ‚Çπ250 (36%)
        </div>

    <!-- ‚úÖ Add to Cart Form -->
    <form method="post" action="{% url 'add_to_cart' 'Eyeliner' %}" class="mt-3">
        {% csrf_token %}
        <input type="hidden" name="shade" id="selectedShade" value="#000000">
        <button type="submit" class="btn-add">Add Selected Eyeliner to Cart üõí</button>
    </form>
</div>

<div class="text-center mt-4">
    <button onclick="history.back()" style="
        padding: 10px 20px;
        font-size: 1rem;
        border-radius: 6px;
        border: none;
        background-color: #000;
        color: white;
        cursor: pointer;
        margin-top: 30px;
    ">
        ‚Üê Go Back
    </button>
</div>

<!-- MediaPipe & Camera -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.min.js"></script>
<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const colorPicker = document.getElementById('eyelinerColor');
    const hiddenShadeInput = document.getElementById('selectedShade'); // ‚úÖ hidden input

    // Upper eyelid landmark indices
    const LEFT_EYE_UPPER = [33, 160, 158, 133];
    const RIGHT_EYE_UPPER = [362, 385, 387, 263];

    const faceMesh = new FaceMesh({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
    });

    faceMesh.setOptions({
        maxNumFaces: 1,
        refineLandmarks: true,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });

    faceMesh.onResults(results => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (results.multiFaceLandmarks) {
            for (const landmarks of results.multiFaceLandmarks) {
                const hex = colorPicker.value;
                const r = parseInt(hex.substr(1, 2), 16);
                const g = parseInt(hex.substr(3, 2), 16);
                const b = parseInt(hex.substr(5, 2), 16);
                ctx.strokeStyle = `rgba(${r}, ${g}, ${b}, 1)`;
                ctx.lineWidth = 0.8;

                [LEFT_EYE_UPPER, RIGHT_EYE_UPPER].forEach(eye => {
                    ctx.beginPath();
                    eye.forEach((index, i) => {
                        const x = landmarks[index].x * canvas.width;
                        const y = landmarks[index].y * canvas.height;
                        if (i === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    });
                    ctx.stroke();
                });
            }
        }
    });

    const camera = new Camera(video, {
        onFrame: async () => {
            await faceMesh.send({ image: video });
        },
        width: 500,
        height: 375
    });
    camera.start();

    // ‚úÖ Update hidden input whenever eyeliner color changes
    colorPicker.addEventListener('input', () => {
        hiddenShadeInput.value = colorPicker.value;
    });
</script>
{% endblock %}
